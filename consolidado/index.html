<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Consolidado - An√°lisis de Capacidad Sistema Q-Flow</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body{font-family:'Aptos','Segoe UI',sans-serif;line-height:1.4;margin:0;padding:10px;background:#f5f5f5;font-size:12px}
        .container{max-width:1600px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 0 15px rgba(0,0,0,0.1)}
        .doc-info{background:#f8f9fa;padding:15px;border-radius:6px;margin-bottom:20px;border-left:4px solid #1a237e;display:grid;grid-template-columns:repeat(2,1fr);gap:15px;font-size:12px;color:#666}
        h1{color:#2c3e50;text-align:center;border-bottom:3px solid #3498db;padding-bottom:10px;margin-bottom:20px;font-size:24px}
        h2{color:#34495e;margin-top:25px;margin-bottom:15px;border-left:4px solid #3498db;padding-left:15px;font-size:18px}
        h3{color:#34495e;margin-top:20px;margin-bottom:10px;font-size:14px}
        .executive-summary{background:linear-gradient(135deg,#2c3e50,#34495e);color:white;padding:20px;border-radius:8px;margin-bottom:25px}
        .executive-summary h2{margin-top:0;color:white;border:none;padding:0;font-size:20px}
        .key-findings{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin:15px 0}
        .finding-card{background:rgba(255,255,255,0.1);padding:15px;border-radius:6px;text-align:center}
        .finding-value{font-size:2em;font-weight:bold;margin-bottom:5px;color:#2ecc71}
        .finding-label{font-size:0.9em;opacity:0.9}
        .results-table{width:100%;border-collapse:collapse;margin:15px 0;font-size:11px}
        .results-table th,.results-table td{border:1px solid #ddd;padding:8px 6px;text-align:center}
        .results-table th{background:linear-gradient(135deg,#3498db,#2980b9);color:white;font-weight:bold}
        .results-table tr:nth-child(even){background:#f9f9f9}
        .results-table tr:hover{background:#e3f2fd}
        .pass{background:#2ecc71;color:white;padding:4px 8px;border-radius:12px;font-weight:bold;font-size:10px}
        .warning{background:#f39c12;color:white;padding:4px 8px;border-radius:12px;font-weight:bold;font-size:10px}
        .fail{background:#e74c3c;color:white;padding:4px 8px;border-radius:12px;font-weight:bold;font-size:10px}
        .chart-container-two{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;clear:both}
        .chart-container-four{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin:20px 0;clear:both}
        .chart-box{background:white;padding:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);height:300px;position:relative;z-index:1}
        .chart-box.large{height:400px}
        .chart-title{text-align:center;color:#2c3e50;margin-bottom:15px;font-weight:bold;font-size:14px}
        .analysis-section{background:#ecf0f1;padding:20px;border-radius:8px;margin:20px 0;font-size:12px;position:relative;z-index:10;clear:both}
        .critical-warning{background:#ffebee;border:2px solid #e74c3c;padding:15px;border-radius:8px;margin:20px 0;font-size:12px;position:relative;z-index:10;clear:both}
        .success-highlight{background:#e8f5e8;border:2px solid #2ecc71;padding:15px;border-radius:8px;margin:20px 0;font-size:12px;position:relative;z-index:10;clear:both}
        .recommendations{background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;margin:20px 0;font-size:12px}
        .phase-indicator{display:inline-block;padding:4px 12px;border-radius:15px;font-weight:bold;font-size:10px;margin-right:8px}
        .phase-optimal{background:#2ecc71;color:white}
        .phase-warning{background:#f39c12;color:white}
        .phase-critical{background:#e74c3c;color:white}
        .nav-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:10px 0;border-bottom:1px solid #e0e0e0}
        .back-btn{background:linear-gradient(135deg,#3498db,#2980b9);color:white;padding:8px 16px;border:none;border-radius:6px;font-size:12px;font-weight:bold;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.3s ease}
        .back-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(52,152,219,0.3)}
        .page-title{color:#2c3e50;font-size:14px;font-weight:bold;margin:0}
        .pdf-header{display:none;text-align:center;margin-bottom:25px;border-bottom:3px solid #1a237e}
        .pdf-header img{width:90%;max-width:1000px;height:auto;max-height:150px;object-fit:contain;margin:10px auto 15px auto;display:block}
        .servers{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin:15px 0}
        .server{background:white;padding:15px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
        .server h4{margin-top:0;font-size:13px}
        .server ul{font-size:10px;margin:0;padding-left:15px}
        .note{background:#fff3cd;border:1px solid #ffeaa7;padding:10px;border-radius:6px;margin-top:15px;font-size:11px;color:#856404}
        @media print{
            .nav-header{display:none!important}
            body{background:white!important;font-size:10px!important;margin:0!important;padding:20px!important}
            .container{box-shadow:none!important;max-width:100%!important;padding:0!important;margin:0!important}
            .chart-box{height:250px!important;page-break-inside:avoid!important}
            .pdf-header{display:block!important}
            body{-webkit-print-color-adjust:exact!important;color-adjust:exact!important}
            .pass,.warning,.fail{background:#2ecc71!important;color:white!important}
            @page{margin:0.4in}
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="pdf-header">
            <img src="https://github.com/michaelherreraacftech/TESTBBVA002/raw/main/assets/images/header-acfv2.png" alt="ACF Technologies">
        </div>

        <div class="nav-header">
            <button class="back-btn" onclick="goBack()"><span>‚Üê</span><span>Regresar</span></button>
            <div class="page-title">Reporte Consolidado - Script TAfterEnq</div>
            <button class="back-btn" onclick="downloadPDF()" style="background:linear-gradient(135deg,#f39c12,#e67e22)"><span>üìÑ</span><span>Descargar PDF</span></button>
        </div>

        <div class="doc-info">
            <div><strong>Fecha:</strong> 3 de Junio, 2025</div>
            <div><strong>Entorno:</strong> QA-DESA</div>
            <div><strong>Cliente:</strong> BBVA Mex</div>
            <div><strong>Script:</strong> TAfterEnq Activo</div>
            <div><strong>Analista:</strong> Michael J Herrera B</div>
            <div><strong>Cargo:</strong> L√≠der de QA</div>
        </div>

        <h1>An√°lisis de Capacidad Sistema Q-Flow - Entorno QA-DESA</h1>
        <p style="text-align:center;color:#7f8c8d;font-style:italic;margin-bottom:25px">
            Evaluaci√≥n Completa de Rendimiento: 12 a 60 Usuarios Concurrentes<br>
            <strong>Script TAfterEnq Activo - TESTBBVA004</strong>
        </p>

        <div class="executive-summary">
            <h2>üìä Resumen Ejecutivo</h2>
            <p><strong>Objetivo:</strong> Evaluar la capacidad del servidor QA-DESA para el sistema Q-Flow ejecutando Script TAfterEnq bajo diferentes niveles de concurrencia de usuarios.</p>
            
            <div class="key-findings">
                <div class="finding-card">
                    <div class="finding-value">36</div>
                    <div class="finding-label">Usuarios Concurrentes<br>√ìptimos</div>
                </div>
                <div class="finding-card">
                    <div class="finding-value">39.1</div>
                    <div class="finding-label">TPS M√°ximo<br>Sostenible</div>
                </div>
                <div class="finding-card">
                    <div class="finding-value">0.96%</div>
                    <div class="finding-label">Tasa de Error<br>M√≠nima</div>
                </div>
            </div>
        </div>

        <h2>üìà Resultados Consolidados por Prueba</h2>
        <table class="results-table">
            <thead>
                <tr>
                    <th>Prueba</th>
                    <th>Usuarios</th>
                    <th>Fase</th>
                    <th>Muestras</th>
                    <th>Errores</th>
                    <th>% Error</th>
                    <th>Tiempo Prom (ms)</th>
                    <th>Max (ms)</th>
                    <th>TPS</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>TESTBBVA004</strong></td>
                    <td>12</td>
                    <td><span class="phase-optimal">√ìPTIMA</span></td>
                    <td>3,600</td>
                    <td>11</td>
                    <td>0.31%</td>
                    <td>335</td>
                    <td>8,870</td>
                    <td>14.6</td>
                    <td><span class="pass">PASS</span></td>
                </tr>
                <tr>
                    <td><strong>TESTBBVA004</strong></td>
                    <td>24</td>
                    <td><span class="phase-optimal">√ìPTIMA</span></td>
                    <td>7,392</td>
                    <td>85</td>
                    <td>1.15%</td>
                    <td>417</td>
                    <td>4,971</td>
                    <td>26.4</td>
                    <td><span class="pass">PASS</span></td>
                </tr>
                <tr>
                    <td><strong>TESTBBVA004</strong></td>
                    <td>36</td>
                    <td><span class="phase-optimal">M√ÅXIMA</span></td>
                    <td>11,088</td>
                    <td>107</td>
                    <td>0.96%</td>
                    <td>406</td>
                    <td>1,915</td>
                    <td>39.1</td>
                    <td><span class="pass">PASS</span></td>
                </tr>
                <tr>
                    <td><strong>TESTBBVA004</strong></td>
                    <td>48</td>
                    <td><span class="phase-warning">SATURACI√ìN</span></td>
                    <td>14,784</td>
                    <td>2,011</td>
                    <td>13.60%</td>
                    <td>845</td>
                    <td>20,693</td>
                    <td>35.4</td>
                    <td><span class="fail">FAIL</span></td>
                </tr>
                <tr>
                    <td><strong>TESTBBVA004</strong></td>
                    <td>60</td>
                    <td><span class="phase-critical">COLAPSO</span></td>
                    <td>18,480</td>
                    <td>5,626</td>
                    <td>30.50%</td>
                    <td>1,340</td>
                    <td>21,083</td>
                    <td>32.4</td>
                    <td><span class="fail">FAIL</span></td>
                </tr>
            </tbody>
        </table>

        <h2>üìä An√°lisis de Tendencias de Rendimiento</h2>
        
        <div class="chart-container-two">
            <div class="chart-box large">
                <div class="chart-title">Throughput vs Usuarios Concurrentes</div>
                <canvas id="throughputChart"></canvas>
            </div>
            <div class="chart-box large">
                <div class="chart-title">Tasa de Errores vs Usuarios Concurrentes</div>
                <canvas id="errorChart"></canvas>
            </div>
        </div>

        <div class="chart-container-two">
            <div class="chart-box large">
                <div class="chart-title">Tiempo de Respuesta Promedio vs Usuarios Concurrentes</div>
                <canvas id="responseTimeChart"></canvas>
            </div>
            <div class="chart-box large">
                <div class="chart-title">Tiempo de Respuesta M√°ximo vs Usuarios Concurrentes</div>
                <canvas id="maxTimeChart"></canvas>
            </div>
        </div>

        <h2>üñ•Ô∏è Evoluci√≥n del Uso de Recursos</h2>
        
        <div class="chart-container-four">
            <div class="chart-box">
                <div class="chart-title">SQL Server - Uso de CPU Promedio</div>
                <canvas id="sqlCpuChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">SQL Server - Actividad de Memoria</div>
                <canvas id="sqlMemoryChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">IIS Servers - Uso Promedio de CPU</div>
                <canvas id="iisCpuChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">IIS Servers - Distribuci√≥n de Carga</div>
                <canvas id="iisDistributionChart"></canvas>
            </div>
        </div>

        <h2>üîç An√°lisis Detallado por Fases</h2>

        <div class="success-highlight">
            <h3>‚úÖ Fase √ìptima (12-36 Usuarios)</h3>
            <ul>
                <li><strong>Sweet Spot Identificado:</strong> 36 usuarios representa el punto √≥ptimo de rendimiento (39.1 TPS, 0.96% error)</li>
                <li><strong>Escalabilidad Extraordinaria:</strong> Throughput incrementa de manera eficiente hasta 36 usuarios (168% aumento vs 12 usuarios)</li>
                <li><strong>Auto-optimizaci√≥n del Sistema:</strong> Parad√≥jicamente, 36 usuarios tiene menor tasa de error que 24 usuarios (0.96% vs 1.15%)</li>
                <li><strong>Latencia Estable:</strong> Tiempo de respuesta se mantiene controlado (335-417ms)</li>
                <li><strong>Hardware Equilibrado:</strong> SQL Server y servidores IIS operan dentro de rangos aceptables</li>
            </ul>
        </div>

        <div class="critical-warning">
            <h3>‚ö†Ô∏è Fase de Saturaci√≥n (48 Usuarios)</h3>
            <ul>
                <li><strong>Punto de Quiebre Definido:</strong> Salto dram√°tico a 13.60% de errores (14x incremento vs 36 usuarios)</li>
                <li><strong>Degradaci√≥n del Throughput:</strong> Primera vez que el TPS disminuye (35.4 vs 39.1 TPS)</li>
                <li><strong>Latencia Cr√≠tica:</strong> Tiempo promedio se duplica (845ms vs 406ms)</li>
                <li><strong>SQL Server Saturado:</strong> CPU sostenido 80-97% durante toda la prueba</li>
                <li><strong>Tiempo M√°ximo Extremo:</strong> Picos de hasta 20.7 segundos indican timeouts del sistema</li>
            </ul>
        </div>

        <div class="critical-warning">
            <h3>üö® Fase de Colapso Total (60 Usuarios)</h3>
            <ul>
                <li><strong>Colapso Confirmado:</strong> 30.50% de errores - sistema completamente inoperativo</li>
                <li><strong>Throughput Colapsado:</strong> Menor rendimiento que 48 usuarios (32.4 vs 35.4 TPS)</li>
                <li><strong>Latencia Catastr√≥fica:</strong> 1,340ms promedio (+230% vs fase √≥ptima)</li>
                <li><strong>Hardware al L√≠mite:</strong> SQL Server al 100% CPU sostenido, actividad de memoria cr√≠tica</li>
                <li><strong>Tiempo M√°ximo Record:</strong> 21.1 segundos m√°ximo, sistema no responde</li>
                <li><strong>Duraci√≥n Extendida:</strong> Prueba de 10 minutos vs 5 minutos, sistema no se recupera</li>
            </ul>
        </div>

        <div class="analysis-section">
            <h3>üíª Especificaciones de Infraestructura QA-DESA</h3>
            
            <div class="servers">
                <div class="server">
                    <h4 style="color:#e74c3c">SQL Server (BBVAMX-UATSQL1)</h4>
                    <ul>
                        <li><strong>OS:</strong> Windows Server 2022 Datacenter</li>
                        <li><strong>CPU:</strong> AMD EPYC 7763 64-Core (2 Core, 4 Logical)</li>
                        <li><strong>RAM:</strong> 7.95 GB Total (2.07 GB Disponible)</li>
                        <li><strong>Virtualizaci√≥n:</strong> Hyper-V Virtual Machine</li>
                        <li><strong>Rol:</strong> Base de Datos Q-Flow (Cuello de botella principal)</li>
                    </ul>
                </div>
                <div class="server">
                    <h4 style="color:#27ae60">IIS Server 1 (BBVAMX-UATIIS1)</h4>
                    <ul>
                        <li><strong>OS:</strong> Windows Server 2022 Datacenter</li>
                        <li><strong>CPU:</strong> AMD EPYC 7763 64-Core (2 Core, 4 Logical)</li>
                        <li><strong>RAM:</strong> 7.95 GB Total (3.38 GB Disponible)</li>
                        <li><strong>Rol:</strong> Web Services Q-Flow</li>
                        <li><strong>Carga:</strong> Subutilizado en comparaci√≥n con IIS2</li>
                    </ul>
                </div>
                <div class="server">
                    <h4 style="color:#3498db">IIS Server 2 (BBVAMX-UATIIS2)</h4>
                    <ul>
                        <li><strong>OS:</strong> Windows Server 2022 Datacenter</li>
                        <li><strong>CPU:</strong> AMD EPYC 7763 64-Core (2 Core, 4 Logical)</li>
                        <li><strong>RAM:</strong> 7.95 GB Total (4.49 GB Disponible)</li>
                        <li><strong>Rol:</strong> Web Services Q-Flow</li>
                        <li><strong>Carga:</strong> Sobrecargado, requiere balanceamiento</li>
                    </ul>
                </div>
            </div>
            
            <div class="note">
                <strong>Nota:</strong> Todas las pruebas ejecutadas con <strong>Script TAfterEnq Activo</strong> exclusivamente, dem√°s scripts inactivos para evaluaci√≥n individual de capacidad.
            </div>
        </div>

        <div class="analysis-section">
            <h3>üìã Hallazgos T√©cnicos Clave</h3>
            <ul>
                <li><strong>Patr√≥n de Escalamiento No-Lineal:</strong> Sistema mejora entre 24-36 usuarios antes del colapso</li>
                <li><strong>SQL Server como Limitante:</strong> √önico cuello de botella identificado en todas las pruebas</li>
                <li><strong>Punto de Quiebre Abrupto:</strong> Cambio dram√°tico entre 36 usuarios (PASS) y 48 usuarios (FAIL)</li>
                <li><strong>Desbalance de Carga IIS:</strong> IIS2 consistentemente m√°s cargado que IIS1</li>
                <li><strong>Script TAfterEnq Optimizado:</strong> Demuestra excelente eficiencia hasta el l√≠mite del hardware</li>
                <li><strong>Comportamiento Predictivo:</strong> Degradaci√≥n gradual desde 48 hasta colapso total en 60</li>
                <li><strong>Memoria como Factor Secundario:</strong> CPU es el limitante principal, no la memoria</li>
                <li><strong>Timeouts del Sistema:</strong> Tiempos m√°ximos indican timeouts de aplicaci√≥n y BD</li>
            </ul>
            
            <h4>üìÑ Evidencia de Errores del Sistema:</h4>
            <p style="margin:10px 0;font-size:11px">Durante las pruebas de alta carga se registraron errores cr√≠ticos que confirman la saturaci√≥n del sistema:</p>
            
            <div style="background:white;padding:15px;border-radius:6px;margin:15px 0;border-left:3px solid #e74c3c">
                <h5 style="margin-top:0;color:#e74c3c;font-size:12px">üî¥ Error de Conversation Handle - Event ID: 2460800</h5>
                <div style="background:#f8f9fa;padding:8px;border-radius:4px;font-family:monospace;font-size:9px;margin:5px 0">
                    <strong>Event Time:</strong> 6/3/2025 5:57:17 PM<br>
                    <strong>Source:</strong> qf.ProcessUpdateSkilledAgents<br>
                    <strong>Details:</strong> The conversation handle "EA855D75-D640-F011-9511-6045BDF036F1" is not found.
                </div>
            </div>
            
            <div style="background:white;padding:15px;border-radius:6px;margin:15px 0;border-left:3px solid #e74c3c">
                <h5 style="margin-top:0;color:#e74c3c;font-size:12px">üî¥ Error de QFlow Library Exception - Event ID: 2460763</h5>
                <div style="background:#f8f9fa;padding:8px;border-radius:4px;font-family:monospace;font-size:9px;margin:5px 0">
                    <strong>Event Time:</strong> 6/3/2025 5:55:58 PM<br>
                    <strong>Source:</strong> ReceptionPoint.SaveTicket<br>
                    <strong>Details:</strong> Transaction (Process ID 91) was deadlocked on lock resources with another process and has been chosen as the deadlock victim. Rerun the transaction.
                </div>
            </div>
            
            <div style="background:white;padding:15px;border-radius:6px;margin:15px 0;border-left:3px solid #e74c3c">
                <h5 style="margin-top:0;color:#e74c3c;font-size:12px">üî¥ Error de SqlClient SqlException - Event ID: 2460763</h5>
                <div style="background:#f8f9fa;padding:8px;border-radius:4px;font-family:monospace;font-size:9px;margin:5px 0">
                    <strong>Event Time:</strong> 6/3/2025 5:55:58 PM<br>
                    <strong>Source:</strong> System.Data.SqlClient.SqlException<br>
                    <strong>Details:</strong> SqlDataReader.dataStream. Boolean callersHasConnectionLock. Boolean asyncClose)
                </div>
            </div>
            
            <p style="margin:10px 0;font-size:11px;color:#c0392b"><strong>IMPORTANTE:</strong> Se registraron m√∫ltiples instancias de estos errores durante las pruebas de 48 y 60 usuarios, confirmando la saturaci√≥n del sistema. Se adjunta el archivo de log de Q-Flow para validar los errores en detalle.</p>
        </div>

        <div class="recommendations">
            <h3>üéØ Recomendaciones Estrat√©gicas</h3>
            
            <h4>Para Script TAfterEnq en QA-DESA:</h4>
            <ul>
                <li><strong>L√≠mite Operacional:</strong> M√°ximo 36 usuarios concurrentes para rendimiento √≥ptimo</li>
                <li><strong>Monitoreo Cr√≠tico:</strong> Alertas cuando CPU SQL Server > 80%</li>
                <li><strong>Prevenci√≥n de Deadlocks:</strong> Implementar timeouts y retry logic apropiados</li>
                <li><strong>Gesti√≥n de Conversation Handles:</strong> Implementar validaci√≥n y limpieza de handles</li>
            </ul>
            
            <h4>Para Optimizaci√≥n del Script:</h4>
            <ul>
                <li><strong>Revisi√≥n de Consultas:</strong> Optimizar queries de base de datos del script TAfterEnq</li>
                <li><strong>Indexaci√≥n:</strong> Revisar √≠ndices para operaciones TAfterEnq</li>
                <li><strong>Connection Pooling:</strong> Optimizar gesti√≥n de conexiones de base de datos</li>
                <li><strong>Gesti√≥n de Transacciones:</strong> Revisar tama√±o y duraci√≥n de transacciones</li>
                <li><strong>Paginaci√≥n:</strong> Implementar paginaci√≥n en resultados grandes</li>
                <li><strong>Manejo de Excepciones:</strong> Mejorar captura y manejo de SqlExceptions</li>
            </ul>
            
            <h4>Para Incremento de Capacidad del Sistema:</h4>
            <ul>
                <li><strong>SQL Server CPU:</strong> Incrementar de 2 a 4+ cores m√≠nimo para soportar mayor concurrencia</li>
                <li><strong>SQL Server RAM:</strong> Evaluar incremento de memoria para buffering y cache</li>
                <li><strong>Balanceador de Carga:</strong> Implementar distribuci√≥n equitativa entre servidores IIS</li>
                <li><strong>Optimizaci√≥n de BD:</strong> Revisar y optimizar √≠ndices espec√≠ficos para TAfterEnq</li>
                <li><strong>Connection Management:</strong> Configurar pool de conexiones apropiado</li>
                <li><strong>Timeout Configuration:</strong> Ajustar timeouts de conexi√≥n y comando</li>
            </ul>
            
            <h4>Acceso para Validaciones:</h4>
            <ul>
                <li><strong>Base de Datos Q-Flow:</strong> Disponible para el equipo t√©cnico para an√°lisis adicionales</li>
                <li><strong>Interfaz Web Q-Flow:</strong> Acceso habilitado para validaciones funcionales</li>
                <li><strong>Logs del Sistema:</strong> Archivo de eventos Q-Flow disponible para revisi√≥n detallada</li>
                <li><strong>Entorno de Pruebas:</strong> QA-DESA disponible para replicar escenarios de carga</li>
            </ul>
        </div>

        <div class="executive-summary">
            <h2>üí° Conclusiones Finales</h2>
            <p><strong>El Script TAfterEnq demuestra un rendimiento excepcional con un comportamiento de escalamiento √∫nico que alcanza su punto √≥ptimo en 36 usuarios concurrentes.</strong> 
            El sistema presenta un patr√≥n de auto-optimizaci√≥n entre 24-36 usuarios, seguido de un punto de quiebre abrupto en 48 usuarios debido a limitaciones de hardware.</p>
            
            <p style="margin-top:15px"><strong>Capacidad Actual:</strong> 36 usuarios concurrentes m√°ximo operacional con 39.1 TPS y 0.96% de error.</p>
            
            <p style="margin-top:15px"><strong>Necesidad de Escalamiento:</strong> Para soportar mayor concurrencia, el sistema requiere incremento en la capacidad de procesamiento del SQL Server, principalmente CPU y optimizaci√≥n de base de datos.</p>
            
            <p style="margin-top:15px;color:#c0392b;font-weight:bold">‚ö†Ô∏è <strong>Requisito Cr√≠tico para Aprobaci√≥n:</strong> Es indispensable validar el procesamiento de los deadlocks y timeouts identificados en las pruebas antes de proceder con la aprobaci√≥n de uso del Script TAfterEnq en entornos de producci√≥n.</p>
            
            <p style="margin-top:15px"><em>Este an√°lisis establece que TAfterEnq es altamente eficiente pero est√° limitado por la capacidad actual de hardware del entorno QA-DESA. Con las mejoras recomendadas y la resoluci√≥n de los issues de deadlocks, el sistema podr√≠a escalar significativamente.</em></p>
        </div>
    </div>

<script>
function waitForChart(){return new Promise(r=>{const c=()=>{typeof Chart!=='undefined'?r():setTimeout(c,100)};c()})}

async function initializeCharts(){
    console.log('üîÑ Cargando gr√°ficos consolidados TAfterEnq...');
    
    try{
        await waitForChart();
        
        // Datos reales de las pruebas realizadas
        const data={
            users:[12,24,36,48,60],
            throughput:[14.6,26.4,39.1,35.4,32.4],
            errorRate:[0.31,1.15,0.96,13.60,30.50],
            avgResponseTime:[335,417,406,845,1340],
            maxResponseTime:[8870,4971,1915,20693,21083],
            // Promedio estimado de CPU por prueba basado en los gr√°ficos
            sqlCpu:[65,78,85,90,95],
            sqlMemory:[18,21,26,21.5,21.5], // Pages/sec - datos corregidos basados en Performance Monitor
            // Promedio entre IIS1 e IIS2
            iisCpuAvg:[25,38,40,42,21],
            // Diferencia entre IIS2 e IIS1 para mostrar desbalance
            iisBalance:[15,30,35,40,15]
        };

        const config={
            responsive:true,
            maintainAspectRatio:true,
            aspectRatio:1.8,
            scales:{
                x:{title:{display:true,text:'Usuarios Concurrentes',font:{size:12}}},
                y:{beginAtZero:true,title:{font:{size:12}}}
            },
            plugins:{legend:{display:false}}
        };

        // Gr√°fico de Throughput
        new Chart(document.getElementById('throughputChart'),{
            type:'line',
            data:{
                labels:data.users,
                datasets:[{
                    data:data.throughput,
                    borderColor:'#2ecc71',
                    backgroundColor:'rgba(46,204,113,0.1)',
                    borderWidth:3,
                    pointBackgroundColor:['#2ecc71','#2ecc71','#27ae60','#f39c12','#e74c3c'],
                    pointBorderColor:'#fff',
                    pointBorderWidth:2,
                    pointRadius:8,
                    tension:0.3,
                    fill:true
                }]
            },
            options:{...config,scales:{...config.scales,y:{...config.scales.y,title:{display:true,text:'Transacciones por Segundo (TPS)',font:{size:12}}}}}
        });

        // Gr√°fico de Tasa de Errores
        new Chart(document.getElementById('errorChart'),{
            type:'line',
            data:{
                labels:data.users,
                datasets:[{
                    data:data.errorRate,
                    borderColor:'#e74c3c',
                    backgroundColor:'rgba(231,76,60,0.1)',
                    borderWidth:3,
                    pointBackgroundColor:['#2ecc71','#f39c12','#2ecc71','#e74c3c','#c0392b'],
                    pointBorderColor:'#fff',
                    pointBorderWidth:2,
                    pointRadius:8,
                    tension:0.3,
                    fill:true
                }]
            },
            options:{...config,scales:{...config.scales,y:{...config.scales.y,title:{display:true,text:'Porcentaje de Errores (%)',font:{size:12}}}}}
        });

        // Gr√°fico de Tiempo de Respuesta Promedio
        new Chart(document.getElementById('responseTimeChart'),{
            type:'line',
            data:{
                labels:data.users,
                datasets:[{
                    data:data.avgResponseTime,
                    borderColor:'#9b59b6',
                    backgroundColor:'rgba(155,89,182,0.1)',
                    borderWidth:3,
                    pointBackgroundColor:['#2ecc71','#f39c12','#2ecc71','#e74c3c','#c0392b'],
                    pointBorderColor:'#fff',
                    pointBorderWidth:2,
                    pointRadius:8,
                    tension:0.3,
                    fill:true
                }]
            },
            options:{...config,scales:{...config.scales,y:{...config.scales.y,title:{display:true,text:'Tiempo Promedio (ms)',font:{size:12}}}}}
        });

        // Gr√°fico de Tiempo de Respuesta M√°ximo
        new Chart(document.getElementById('maxTimeChart'),{
            type:'line',
            data:{
                labels:data.users,
                datasets:[{
                    data:data.maxResponseTime,
                    borderColor:'#e67e22',
                    backgroundColor:'rgba(230,126,34,0.1)',
                    borderWidth:3,
                    pointBackgroundColor:['#e67e22','#e74c3c','#2ecc71','#e74c3c','#c0392b'],
                    pointBorderColor:'#fff',
                    pointBorderWidth:2,
                    pointRadius:8,
                    tension:0.3,
                    fill:true
                }]
            },
            options:{...config,scales:{...config.scales,y:{...config.scales.y,title:{display:true,text:'Tiempo M√°ximo (ms)',font:{size:12}}}}}
        });

        const resourceConfig={
            responsive:true,
            maintainAspectRatio:true,
            aspectRatio:1.5,
            scales:{
                x:{title:{display:true,text:'Usuarios Concurrentes',font:{size:11}}},
                y:{beginAtZero:true,max:100,title:{display:true,text:'Uso (%)',font:{size:11}}}
            },
            plugins:{legend:{display:false}}
        };

        // Gr√°fico SQL CPU
        new Chart(document.getElementById('sqlCpuChart'),{
            type:'bar',
            data:{
                labels:data.users,
                datasets:[{
                    data:data.sqlCpu,
                    backgroundColor:['#2ecc71','#f39c12','#e67e22','#e74c3c','#c0392b'],
                    borderWidth:1,
                    borderRadius:4
                }]
            },
            options:resourceConfig
        });

        // Gr√°fico SQL Memoria
        new Chart(document.getElementById('sqlMemoryChart'),{
            type:'bar',
            data:{
                labels:data.users,
                datasets:[{
                    data:data.sqlMemory,
                    backgroundColor:['#3498db','#5dade2','#74b9ff','#e67e22','#e74c3c'],
                    borderWidth:1,
                    borderRadius:4
                }]
            },
            options:{...resourceConfig,scales:{...resourceConfig.scales,y:{...resourceConfig.scales.y,title:{display:true,text:'Pages/sec',font:{size:11}},max:30}}}
        });

        // Gr√°fico IIS CPU Promedio
        new Chart(document.getElementById('iisCpuChart'),{
            type:'bar',
            data:{
                labels:data.users,
                datasets:[{
                    data:data.iisCpuAvg,
                    backgroundColor:['#27ae60','#58d68d','#52c41a','#f39c12','#e67e22'],
                    borderWidth:1,
                    borderRadius:4
                }]
            },
            options:resourceConfig
        });

        // Gr√°fico de Distribuci√≥n IIS
        new Chart(document.getElementById('iisDistributionChart'),{
            type:'bar',
            data:{
                labels:data.users,
                datasets:[{
                    label:'IIS2 - IIS1 (Desbalance)',
                    data:data.iisBalance,
                    backgroundColor:['#f39c12','#e67e22','#e74c3c','#c0392b','#8e44ad'],
                    borderWidth:1,
                    borderRadius:4
                }]
            },
            options:{...resourceConfig,scales:{...resourceConfig.scales,y:{...resourceConfig.scales.y,title:{display:true,text:'Diferencia CPU (%)',font:{size:11}},max:50}}}
        });

        console.log('üéØ Todos los gr√°ficos consolidados TAfterEnq creados exitosamente!');
        
    }catch(error){
        console.error('‚ùå Error creando gr√°ficos consolidados:',error);
    }
}

document.addEventListener('DOMContentLoaded',initializeCharts);
window.addEventListener('load',initializeCharts);
if(document.readyState==='complete')initializeCharts();

function goBack(){window.history.length>1?window.history.back():window.location.href='../index.html';}
document.addEventListener('keydown',function(e){if(e.key==='Escape')goBack();});

function downloadPDF(){
    const t=document.title;
    document.title='Reporte_BBVA_Consolidado_TAfterEnq_TESTBBVA004_'+new Date().toISOString().split('T')[0];
    document.querySelectorAll('.nav-header,header,nav').forEach(el=>el.style.display='none');
    
    const s={fontSize:document.body.style.fontSize,background:document.body.style.background,margin:document.body.style.margin,padding:document.body.style.padding};
    document.body.style.fontSize='9px';
    document.body.style.background='white';
    document.body.style.margin='0';
    document.body.style.padding='0';
    
    const st=document.createElement('style');
    st.innerHTML=`
        @media print{
            @page{margin:0.5in;size:A4}
            .nav-header,header,nav{display:none!important}
            body{-webkit-print-color-adjust:exact!important;color-adjust:exact!important}
            .chart-box{height:200px!important;page-break-inside:avoid!important}
            .chart-box canvas{max-height:180px!important;max-width:100%!important}
            .analysis-section,.critical-warning,.success-highlight{page-break-inside:avoid!important}
        }
    `;
    document.head.appendChild(st);
    
    setTimeout(()=>{
        window.print();
        setTimeout(()=>{
            document.title=t;
            document.body.style.fontSize=s.fontSize;
            document.body.style.background=s.background;
            document.body.style.margin=s.margin;
            document.body.style.padding=s.padding;
            document.querySelectorAll('.nav-header,header,nav').forEach(el=>el.style.display='');
            document.head.removeChild(st);
        },1000);
    },200);
}
</script>
</body>
</html>
